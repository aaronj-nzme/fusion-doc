

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Defining a Content Source &mdash; Fusion-Doc 1.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Using Environment Variables and “Secrets”" href="environment.html" />
    <link rel="prev" title="Event Handling and Interaction" href="event-handling.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Fusion-Doc
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Components:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="output.html">Creating and Using Output Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="feature.html">Creating a Feature Component</a></li>
<li class="toctree-l1"><a class="reference internal" href="layout.html">Creating a Layout Component</a></li>
<li class="toctree-l1"><a class="reference internal" href="chain.html">Creating a Chain Component</a></li>
<li class="toctree-l1"><a class="reference internal" href="event-handling.html">Event Handling and Interaction</a></li>
</ul>
<p class="caption"><span class="caption-text">Data:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Defining a Content Source</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#defining-a-content-source-in-javascript">Defining a Content Source in JavaScript</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#resolve-property-content-source-must-have-either-a-resolve-or-fetch-property">resolve property (content source must have either a resolve or fetch property)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fetch-property-required-unless-using-the-resolve-property">fetch property (required, unless using the resolve property)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#params-property-required">params property (required)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#transform-property-optional">transform property (optional)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#defining-a-content-source-in-json">Defining a Content Source in JSON</a></li>
<li class="toctree-l2"><a class="reference internal" href="#using-content-base">Using CONTENT_BASE</a></li>
<li class="toctree-l2"><a class="reference internal" href="#content-caching-server-side">Content Caching (Server Side)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="environment.html">Using Environment Variables and “Secrets”</a></li>
<li class="toctree-l1"><a class="reference internal" href="consumer-hoc.html">Using the Consumer Higher-Order Function</a></li>
<li class="toctree-l1"><a class="reference internal" href="fetching-content.html">Fetching Content</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuring-content.html">Dynamically Configuring Content</a></li>
<li class="toctree-l1"><a class="reference internal" href="content-filtering.html">Content Filtering in Fusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="site-properties.html">Using Site Properties</a></li>
</ul>
<p class="caption"><span class="caption-text">General:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Folder.html">Examining the Feature Pack</a></li>
<li class="toctree-l1"><a class="reference internal" href="style.html">Adding Styling to Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom-fields.html">Adding Custom Fields to Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="display-properties.html">Working with Display Properties</a></li>
<li class="toctree-l1"><a class="reference internal" href="isomorphic-server-spa.html">Isomorphic vs. Server vs. SPA rendering</a></li>
<li class="toctree-l1"><a class="reference internal" href="messga-between-components.html">Messaging Between Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom-error-page.html">Using Custom Error Pages</a></li>
<li class="toctree-l1"><a class="reference internal" href="return-non-html-content-type.html">Creating a Web API Returning a Non-HTML Content Type</a></li>
<li class="toctree-l1"><a class="reference internal" href="service-work.html">Using Service Workers with Fusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="local-webpack-states-file.html">Locally Generated Webpack Stats File</a></li>
<li class="toctree-l1"><a class="reference internal" href="static-features-outside-of-fusion.html">Including Static Features Outside of Fusion</a></li>
</ul>
<p class="caption"><span class="caption-text">Best Practices:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="bp.html">Best Practices</a></li>
</ul>
<p class="caption"><span class="caption-text">Hooks:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="hooks-configuring-content.html">Dynamically Configuring Content</a></li>
<li class="toctree-l1"><a class="reference internal" href="hooks-fetching-content.html">Fetching Content</a></li>
<li class="toctree-l1"><a class="reference internal" href="hooks-event-handling.html">Event Handling and Interaction</a></li>
<li class="toctree-l1"><a class="reference internal" href="hooks.html">React Hooks</a></li>
</ul>
<p class="caption"><span class="caption-text">API:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api-output.html">Output Type API</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-feature.html">Feature API</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-layout.html">Layout API</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-chain.html">Chain API</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-custom-fields.html">Custom Fields API</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-consumer.html">Consumer API</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-context.html">Context Component API</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-content.html">Content Component API</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-static.html">Static Component API</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-content-source.html">Content Source API</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-plugins.html">Plugins API</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-local-development-mock.html">Local Mocks API</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-site-properties.html">Site Properties API</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-fusion-http.html">Fusion HTTP API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Fusion-Doc</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Defining a Content Source</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/content-source.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="defining-a-content-source">
<h1>Defining a Content Source<a class="headerlink" href="#defining-a-content-source" title="Permalink to this headline">¶</a></h1>
<p>At this point, we have 2 of the <a class="reference external" href="./intro.md#how-does-it-work">3 inputs Fusion needs to function</a> - we’ve defined some <strong>code</strong> for our components, and we’re using PageBuilder Admin to provide <strong>configuration</strong> to our webpages. The last input we need is <strong>content</strong> to fill in our components with live data. To retrieve content, the first thing we need is a content source - a URI to fetch content from, along with some information about what data that URI needs to perform a query.</p>
<div class="section" id="defining-a-content-source-in-javascript">
<h2>Defining a Content Source in JavaScript<a class="headerlink" href="#defining-a-content-source-in-javascript" title="Permalink to this headline">¶</a></h2>
<p>A Fusion content source requires at least 2 pieces of information: a URL endpoint to request JSON from, and a list of params we need to craft the URL. A third piece of info is also often useful (but not required): a GraphQL schema that describes the response shape of the endpoint.</p>
<blockquote>
<div>NOTE As of version 2.2, Fusion no longer uses GraphQL for schemas and instead uses a custom function that works similarly, but much less restrictive. The schema will effectively be ignored - however, filtering syntax will still work as before.</div></blockquote>
<p>Since our website is supposed to be for movie lovers, let’s see what a simple content source definition might look like if we were requesting some data from the <a class="reference external" href="https://www.omdbapi.com/">OMDB API</a>. For this content source, we want to be able to find a certain movie’s information based on its title.</p>
<p>Let’s create a file called <code class="docutils literal notranslate"><span class="pre">movie-find.js</span></code> in the <code class="docutils literal notranslate"><span class="pre">/content/sources/</span></code> directory of our bundle. Because our file is named <code class="docutils literal notranslate"><span class="pre">movie-find.js</span></code>, we will refer to this content source as <code class="docutils literal notranslate"><span class="pre">movie-find</span></code> later in our code (and in PageBuilder Admin).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/*    /content/sources/movie-find.js    */

import { OMDB_API_KEY } from &#39;fusion:environment&#39;

const resolve = (query) =&gt; {
  const requestUri = `https://www.omdbapi.com/?apikey=${OMDB_API_KEY}&amp;plot=full`

  if (query.hasOwnProperty(&#39;movieTitle&#39;)) return `${requestUri}&amp;t=${query.movieTitle}`

  throw new Error(&#39;movie-find content source requires a movieTitle&#39;)
}

export default {
  resolve,
  params: {
    movieTitle: &#39;text&#39;
  }
}
</pre></div>
</div>
<p>In the exported object above, we define both required pieces of data that we need for our content source:</p>
<p>Note: A Content Source should include exactly one of resolve or fetch.</p>
<div class="section" id="resolve-property-content-source-must-have-either-a-resolve-or-fetch-property">
<h3>resolve property (content source must have either a resolve or fetch property)<a class="headerlink" href="#resolve-property-content-source-must-have-either-a-resolve-or-fetch-property" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">resolve</span></code> property is a function whose output is a URL which returns the JSON we want. It accepts a single argument we’ve named <code class="docutils literal notranslate"><span class="pre">query</span></code> here (but you could call it anything). The <code class="docutils literal notranslate"><span class="pre">query</span></code> object contains the values of the parameters we need to make a request - in this case, we only need the <code class="docutils literal notranslate"><span class="pre">movieTitle</span></code> param. These values are either set in the PageBuilder Admin (for “global” content) and retried by resolvers, or if you’re fetching your own content you will provide the values when you make the fetch call.</p>
<p>We’re able to perform logic in our function to transform the URL however we want. In this example, if a <code class="docutils literal notranslate"><span class="pre">movieTitle</span></code> property exists in the <code class="docutils literal notranslate"><span class="pre">query</span></code> object that was passed to us, we want to use that param to find our movie. If it doesn’t exist (meaning it skipped the <code class="docutils literal notranslate"><span class="pre">if</span></code> block), we will throw an error since we don’t have the data we need to make our request.</p>
<p>Because this URL will typically require some sort of authentication to access, we have access to the <code class="docutils literal notranslate"><span class="pre">fusion:environment</span></code> in content sources, which gives us decrypted access to “secret” environment variables. Here, we are interpolating an <code class="docutils literal notranslate"><span class="pre">OMDB_API_KEY</span></code> environment variable into the URL to authenticate our request.</p>
</div>
<div class="section" id="fetch-property-required-unless-using-the-resolve-property">
<h3>fetch property (required, unless using the resolve property)<a class="headerlink" href="#fetch-property-required-unless-using-the-resolve-property" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">fetch</span></code> property is an async function that, given a query object, should return JSON. <code class="docutils literal notranslate"><span class="pre">fetch</span></code> is used as an alternative to <code class="docutils literal notranslate"><span class="pre">resolve</span></code> when your content source can not be completely derived from a single URL. Starting in fusion release 2.2, all content sources (including those defined as fetch) are cached.</p>
<p>Below is an example of <code class="docutils literal notranslate"><span class="pre">fetch</span></code> being used instead of <code class="docutils literal notranslate"><span class="pre">resolve</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>import request from &#39;request-promise-native&#39;
import { CONTENT_BASE } from &#39;fusion:environment&#39;
import collectionFeed from &#39;./collection-feed&#39;

const options = {
  gzip: true,
  json: true
}

// Add other required fields here which are not present above
const includedFields = [
  &#39;additional_properties&#39;,
  &#39;content_elements&#39;,
  &#39;first_publish_date&#39;,
  &#39;slug&#39;,
  &#39;source&#39;
].join()

const fetch = (query) =&gt; {
  return request({
    uri: `${CONTENT_BASE}${collectionFeed.resolve(query)}`,
    ...options
  }).then((collectionResp) =&gt; {
    const collectionResult = collectionFeed.transform(collectionResp, query)
    const {
      content_elements: contentElements = []
    } = collectionResult
    const ids = contentElements.map(({ _id }) =&gt; _id).join()
    const {
      website
    } = query

    return request({
      uri: `${CONTENT_BASE}/content/v4/ids?website=${website}&amp;ids=${ids}&amp;included_fields=${includedFields}`,
      ...options
    }).then((idsResp) =&gt; {
      const {
        content_elements: stories = []
      } = idsResp

      if (stories.length) {
        collectionResult.content_elements = collectionResult.content_elements.map((collectionStory) =&gt; {
          return {
            ...stories.find(({ _id }) =&gt; _id === collectionStory._id),
            ...collectionStory
          }
        })
      }

      return collectionResult
    })
  })
}

export default {
  fetch,
  schemaName: collectionFeed.schemaName,
  ttl: collectionFeed.ttl,
  params: collectionFeed.params
}
</pre></div>
</div>
</div>
<div class="section" id="params-property-required">
<h3>params property (required)<a class="headerlink" href="#params-property-required" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">params</span></code> property will contain a list of parameter names and data types that this content source needs to make a request. For example, in this content source we only have 1 param that we can use to make a request: the <code class="docutils literal notranslate"><span class="pre">movieTitle</span></code> param. Given either of these pieces of data (as part of the <code class="docutils literal notranslate"><span class="pre">query</span></code> object in our resolve method), we are able to craft a URL (in our <code class="docutils literal notranslate"><span class="pre">resolve</span></code> function) that gets us the data we want (e.g <code class="docutils literal notranslate"><span class="pre">https://www.omdbapi.com/?apikey=&lt;apiKey&gt;&amp;t=Jurassic%20Park</span></code> will get us the info for the movie Jurassic Park).</p>
<p><code class="docutils literal notranslate"><span class="pre">params</span></code> can be defined either as an object (as seen above) or as an array of objects. If defined as an object, each key of the object will be the name of a param, and its value will be the data type of that param. The allowed data types are <code class="docutils literal notranslate"><span class="pre">text</span></code>, <code class="docutils literal notranslate"><span class="pre">number</span></code> and <code class="docutils literal notranslate"><span class="pre">site</span></code>.</p>
<p>We need this list of params enumerated so that we can tell PageBuilder Admin that they exist. Then, editors can set values for those params - for “example” content in Templates and “global” content on Pages.</p>
</div>
<div class="section" id="transform-property-optional">
<h3>transform property (optional)<a class="headerlink" href="#transform-property-optional" title="Permalink to this headline">¶</a></h3>
<p>Another optional parameter that can be provided in the content source object is a <code class="docutils literal notranslate"><span class="pre">transform</span></code> function. The purpose of this function is to transform the JSON response received from our endpoint, in case you want to change the shape of the data somehow before applying a schema to it.</p>
<p>For example, let’s say we wanted to count the number of words in the movie’s plot and append a <code class="docutils literal notranslate"><span class="pre">numPlotWords</span></code> property to the payload for querying later. We could add the following to our exported object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>export default {
  resolve,
  schemaName: &#39;movies&#39;,
  params: { movieQuery: &#39;text&#39; },
  transform: (data) =&gt; {
    return Object.assign(
      data,
      { numPlotWords: data.Plot ? data.Plot.split(&#39; &#39;).length : 0 }
    )
  }
}
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">transform</span></code> function’s only input is the data object it receives from the endpoint you defined, and its only expected output is an object that you want to query against later.</p>
</div>
</div>
<div class="section" id="defining-a-content-source-in-json">
<h2>Defining a Content Source in JSON<a class="headerlink" href="#defining-a-content-source-in-json" title="Permalink to this headline">¶</a></h2>
<p>It’s also possible to define a content source in JSON rather than JavaScript. This method of defining a content source should only be used if you don’t need to perform any logic to craft your content source URL endpoint (other than interpolating variables, which you can still do). This option exists mostly to support legacy PageBuilder content source configurations. More info about this option will be documented in the near future.</p>
</div>
<div class="section" id="using-content-base">
<h2>Using CONTENT_BASE<a class="headerlink" href="#using-content-base" title="Permalink to this headline">¶</a></h2>
<p>Oftentimes, you will have multiple content sources that all share the same base domain. For example, if you are querying Arc’s Content API, you may have a domain like <code class="docutils literal notranslate"><span class="pre">https://username:password&#64;api.client-name.arcpublishing.com</span></code> that many of your content sources share. For this reason, Fusion allows you to define a special <code class="docutils literal notranslate"><span class="pre">CONTENT_BASE</span></code> environment variable that, when present, allows your <code class="docutils literal notranslate"><span class="pre">resolve</span></code> function to return a URL “path” rather than a fully qualified URL, and prefixes the <code class="docutils literal notranslate"><span class="pre">CONTENT_BASE</span></code> before those paths.</p>
<p>For example, let’s say I have my <code class="docutils literal notranslate"><span class="pre">CONTENT_BASE</span></code> environment variable set to <code class="docutils literal notranslate"><span class="pre">https://username:password&#64;api.client-name.arcpublishing.com</span></code>, and I want to define a content source for “stories” at that domain. In that case, my <code class="docutils literal notranslate"><span class="pre">resolve</span></code> function might look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>const resolve = function resolve (query) {
  const requestUri = `/content/v3/stories/?canonical_url=${query.canonical_url || query.uri}`

  return (query.hasOwnProperty(&#39;published&#39;))
    ? `${requestUri}&amp;published=${query.published}`
    : requestUri
}
</pre></div>
</div>
<p>As you can see, the <code class="docutils literal notranslate"><span class="pre">requestUri</span></code> string that we return in this case is not a fully qualified URL, but instead just a path (denoted by the starting <code class="docutils literal notranslate"><span class="pre">/</span></code> character). In this case, Fusion will see that this string is not a full URL and will prefix this path with the value of the <code class="docutils literal notranslate"><span class="pre">CONTENT_BASE</span></code> variable before making its request - so we don’t have to retype the domain in every content source that shares this domain.</p>
<p>Please note, there is nothing preventing you from still returning fully qualified URLs from other content sources - using <code class="docutils literal notranslate"><span class="pre">CONTENT_BASE</span></code> is purely to keep your code DRY.</p>
</div>
<div class="section" id="content-caching-server-side">
<h2>Content Caching (Server Side)<a class="headerlink" href="#content-caching-server-side" title="Permalink to this headline">¶</a></h2>
<p>As we’ve just discussed different ways of <em>fetching</em> content, it’s important and relevant to understand how Fusion <em>caches</em> this content server-side. Content caching is an important aspect of Fusion that is crucial for delivering optimal site performance, stability, and reliability. All fetched content using a content source will be cached in a server-side cache system for the default or defined TTL. You can update or clear the cache by using the PageBuilder Admin content debugger or the Fusion API</p>
<p>To further guarantee site availability and resilience, Fusion will serve “stale” cache items, if possible, in the event that a content update receives a 4xx or 5xx response (exluding 404s). This behavior is enabled by <strong>default</strong> and can be disabled by configuring the <code class="docutils literal notranslate"><span class="pre">serveStaleCache</span></code> content source config to <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p>
<p>See the below diagram for a more visual depiction of the content fetching, caching, and serve stale process.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="environment.html" class="btn btn-neutral float-right" title="Using Environment Variables and “Secrets”" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="event-handling.html" class="btn btn-neutral float-left" title="Event Handling and Interaction" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Guess Me

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>